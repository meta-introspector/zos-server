<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>SOLFUNMEME v2 - P2P Block Fetcher</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { color: #00ff88; }
        button { padding: 10px 20px; margin: 10px 5px; background: #00ff88; border: none; cursor: pointer; }
        button:hover { background: #00cc66; }
        .log { background: #2a2a2a; padding: 15px; margin: 10px 0; border-left: 3px solid #00ff88; max-height: 400px; overflow-y: auto; }
        .log-entry { margin: 5px 0; font-family: monospace; font-size: 12px; }
        .info { color: #00ff88; }
        .error { color: #ff4444; }
        .result { background: #2a2a2a; padding: 15px; margin: 10px 0; }
        pre { margin: 0; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ SOLFUNMEME v2</h1>
        <p>P2P Solana Block Fetcher with Server Telemetry</p>
        
        <div>
            <button onclick="initPlugin()">Initialize Plugin</button>
            <button onclick="fetchBlock()">Fetch Block</button>
            <button onclick="getSignatures()">Get Signatures</button>
            <button onclick="clearLogs()">Clear Logs</button>
        </div>
        
        <div class="log" id="logs">
            <div class="log-entry info">üì± Waiting for plugin initialization...</div>
        </div>
        
        <div class="result" id="result">
            <pre>No data yet</pre>
        </div>
    </div>
    
    <script type="module">
        let plugin = null;
        
        async function log(level, message) {
            const entry = document.createElement('div');
            entry.className = `log-entry ${level}`;
            entry.textContent = `[${new Date().toISOString()}] ${message}`;
            document.getElementById('logs').appendChild(entry);
            
            // Send to server
            try {
                await fetch('/api/telemetry/log', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        level,
                        message,
                        timestamp: new Date().toISOString(),
                        context: 'solana-p2p-web'
                    })
                });
            } catch (e) {
                console.error('Failed to send telemetry:', e);
            }
        }
        
        window.initPlugin = async function() {
            try {
                log('info', 'üì¶ Loading WASM plugin...');
                const { default: init, SolanaP2P } = await import('./solana_p2p_plugin.js');
                await init();
                plugin = new SolanaP2P();
                log('info', `‚úÖ Plugin initialized: ${plugin.name()}`);
                log('info', `üìù Contract: ${plugin.get_contract()}`);
            } catch (e) {
                log('error', `‚ùå Failed to load plugin: ${e.message}`);
            }
        };
        
        window.fetchBlock = async function() {
            if (!plugin) {
                log('error', '‚ùå Plugin not initialized');
                return;
            }
            
            try {
                const slot = Math.floor(Math.random() * 1000000);
                log('info', `üîç Fetching block ${slot}...`);
                const result = await plugin.get_block(slot);
                document.getElementById('result').innerHTML = `<pre>${JSON.stringify(result, null, 2)}</pre>`;
                log('info', `‚úÖ Block ${slot} fetched`);
            } catch (e) {
                log('error', `‚ùå Error: ${e.message}`);
            }
        };
        
        window.getSignatures = async function() {
            if (!plugin) {
                log('error', '‚ùå Plugin not initialized');
                return;
            }
            
            try {
                log('info', 'üîç Fetching signatures...');
                const result = await plugin.get_signatures();
                document.getElementById('result').innerHTML = `<pre>${JSON.stringify(result, null, 2)}</pre>`;
                log('info', '‚úÖ Signatures fetched');
            } catch (e) {
                log('error', `‚ùå Error: ${e.message}`);
            }
        };
        
        window.clearLogs = function() {
            document.getElementById('logs').innerHTML = '<div class="log-entry info">üì± Logs cleared</div>';
        };
        
        // Auto-init and test
        log('info', 'üåê Page loaded, ready to initialize plugin');
        
        // Auto-test sequence
        setTimeout(async () => {
            await initPlugin();
            
            // Run tests
            setTimeout(async () => {
                log('info', 'üß™ Starting auto-test...');
                
                // Test 1: Fetch block
                await fetchBlock();
                await new Promise(r => setTimeout(r, 1000));
                
                // Test 2: Get signatures
                await getSignatures();
                await new Promise(r => setTimeout(r, 1000));
                
                // Test 3: Multiple blocks
                for (let i = 0; i < 3; i++) {
                    await fetchBlock();
                    await new Promise(r => setTimeout(r, 500));
                }
                
                log('info', '‚úÖ Auto-test complete');
                
                // Post results to server
                const results = {
                    status: 'success',
                    tests_run: 5,
                    timestamp: new Date().toISOString(),
                    plugin: 'solana-p2p',
                    contract: 'BwUTq7fS6sfUmHDwAiCQZ3asSiPEapW5zDrsbwtapump'
                };
                
                await fetch('/api/telemetry/log', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        level: 'info',
                        message: `Auto-test results: ${JSON.stringify(results)}`,
                        timestamp: new Date().toISOString(),
                        context: 'auto-test'
                    })
                });
                
                log('info', 'üì§ Results posted to server');
            }, 2000);
        }, 1000);
    </script>
</body>
</html>
