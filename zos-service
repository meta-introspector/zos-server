#!/bin/bash
# Generic ZOS Service Init Script
# Usage: ./zos-service {start|stop|restart|status} [service_name]

# Configuration
DEFAULT_SERVICE="zos_server"
SERVICE_NAME="${2:-$DEFAULT_SERVICE}"
SERVICE_PATH="$(pwd)/target/release/$SERVICE_NAME"
PIDFILE="/tmp/$SERVICE_NAME.pid"
LOGFILE="/tmp/$SERVICE_NAME.log"
USER=$(whoami)

# Service-specific configurations
case "$SERVICE_NAME" in
    "zos_server")
        BUILD_BIN="zos_server"
        DEFAULT_PORT="8080"
        DASHBOARD_URL="http://localhost:$DEFAULT_PORT"
        API_URL="http://localhost:$DEFAULT_PORT/api"
        ;;
    "value_lattice_server")
        BUILD_BIN="value_lattice_server"
        DEFAULT_PORT="3030"
        DASHBOARD_URL="http://localhost:$DEFAULT_PORT/dashboard"
        API_URL="http://localhost:$DEFAULT_PORT/status"
        ;;
    *)
        BUILD_BIN="$SERVICE_NAME"
        DEFAULT_PORT="8080"
        DASHBOARD_URL="http://localhost:$DEFAULT_PORT"
        API_URL="http://localhost:$DEFAULT_PORT/api"
        ;;
esac

start() {
    if [ -f $PIDFILE ]; then
        echo "ðŸ”´ $SERVICE_NAME is already running (PID: $(cat $PIDFILE))"
        return 1
    fi

    echo "ðŸš€ Starting $SERVICE_NAME..."

    # Build if needed
    if [ ! -f "$SERVICE_PATH" ]; then
        echo "ðŸ“¦ Building $SERVICE_NAME..."
        if [ "$SERVICE_NAME" = "zos_server" ]; then
            cargo build --release
        else
            cargo build --release --bin $BUILD_BIN
        fi
    fi

    # Start daemon with service-specific args
    if [ "$SERVICE_NAME" = "zos_server" ]; then
        nohup $SERVICE_PATH serve > $LOGFILE 2>&1 &
    else
        nohup $SERVICE_PATH > $LOGFILE 2>&1 &
    fi

    PID=$!
    echo $PID > $PIDFILE

    sleep 2
    if kill -0 $PID 2>/dev/null; then
        echo "âœ… $SERVICE_NAME started (PID: $PID)"
        echo "ðŸŒ Dashboard: $DASHBOARD_URL"
        echo "ðŸ“Š API: $API_URL"
        echo "ðŸ“ Logs: tail -f $LOGFILE"
    else
        echo "âŒ Failed to start $SERVICE_NAME"
        rm -f $PIDFILE
        return 1
    fi
}

stop() {
    if [ ! -f $PIDFILE ]; then
        echo "ðŸ”´ $SERVICE_NAME is not running"
        return 1
    fi

    PID=$(cat $PIDFILE)
    echo "ðŸ›‘ Stopping $SERVICE_NAME (PID: $PID)..."

    kill $PID
    sleep 2

    if kill -0 $PID 2>/dev/null; then
        echo "âš ï¸  Force killing $SERVICE_NAME..."
        kill -9 $PID
    fi

    rm -f $PIDFILE
    echo "âœ… $SERVICE_NAME stopped"
}

status() {
    if [ -f $PIDFILE ]; then
        PID=$(cat $PIDFILE)
        if kill -0 $PID 2>/dev/null; then
            echo "ðŸŸ¢ $SERVICE_NAME is running (PID: $PID)"
            echo "ðŸŒ Dashboard: $DASHBOARD_URL"
            echo "ðŸ“Š Memory usage: $(ps -p $PID -o rss= 2>/dev/null | awk '{print $1/1024 " MB"}' || echo "N/A")"

            # Test connectivity
            if command -v curl >/dev/null 2>&1; then
                if curl -s --connect-timeout 2 "$DASHBOARD_URL" >/dev/null; then
                    echo "âœ… Service responding"
                else
                    echo "âš ï¸  Service not responding"
                fi
            fi
            return 0
        else
            echo "ðŸ”´ $SERVICE_NAME is not running (stale PID file)"
            rm -f $PIDFILE
            return 1
        fi
    else
        echo "ðŸ”´ $SERVICE_NAME is not running"
        return 1
    fi
}

restart() {
    stop
    sleep 1
    start
}

list_services() {
    echo "ðŸ”§ Available ZOS Services:"
    echo "  zos_server           - Main ZOS server (port 8080)"
    echo "  value_lattice_server - Value lattice indexer (port 3030)"
    echo ""
    echo "ðŸ“Š Current Status:"
    for service in zos_server value_lattice_server; do
        if [ -f "/tmp/$service.pid" ]; then
            PID=$(cat "/tmp/$service.pid")
            if kill -0 $PID 2>/dev/null; then
                echo "  $service: ðŸŸ¢ Running (PID: $PID)"
            else
                echo "  $service: ðŸ”´ Stopped (stale PID)"
            fi
        else
            echo "  $service: ðŸ”´ Stopped"
        fi
    done
}

case "$1" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    restart)
        restart
        ;;
    status)
        status
        ;;
    list)
        list_services
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|status|list} [service_name]"
        echo ""
        echo "ðŸ”§ ZOS Service Manager"
        echo "Commands:"
        echo "  start [service]   - Start service daemon (default: zos_server)"
        echo "  stop [service]    - Stop service daemon"
        echo "  restart [service] - Restart service daemon"
        echo "  status [service]  - Check service status"
        echo "  list              - List all services and their status"
        echo ""
        echo "Services:"
        echo "  zos_server           - Main ZOS server"
        echo "  value_lattice_server - Value lattice indexer"
        echo ""
        echo "Examples:"
        echo "  $0 start                    # Start ZOS server"
        echo "  $0 start value_lattice_server # Start lattice server"
        echo "  $0 list                     # Show all service status"
        exit 1
        ;;
esac

exit $?
