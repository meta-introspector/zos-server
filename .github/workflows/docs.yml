name: ğŸ“š Documentation & Performance Reports

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  docs:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ¦€ Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: ğŸ“¦ Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-docs-${{ hashFiles('**/Cargo.lock') }}

    - name: ğŸ“– Generate rustdoc
      run: |
        cargo doc --all-features --no-deps --document-private-items
        echo '<meta http-equiv="refresh" content="0; url=zos_server">' > target/doc/index.html

    - name: ğŸ” Generate clippy report
      run: |
        cargo clippy --all-features --message-format=json > clippy-report.json || true
        mkdir -p target/doc/reports

    - name: ğŸ“Š Performance benchmarks
      run: |
        cargo build --release --all-features
        mkdir -p target/doc/perf

        # Basic performance metrics
        echo "# Performance Report - $(date -Iseconds)" > target/doc/perf/latest.md
        echo "" >> target/doc/perf/latest.md
        echo "## Binary Size" >> target/doc/perf/latest.md
        ls -lh target/release/zos_server | awk '{print "- Executable: " $5}' >> target/doc/perf/latest.md
        echo "" >> target/doc/perf/latest.md

        # Compilation time
        echo "## Build Performance" >> target/doc/perf/latest.md
        time cargo build --release --all-features 2>&1 | grep real | awk '{print "- Build time: " $2}' >> target/doc/perf/latest.md || echo "- Build time: N/A" >> target/doc/perf/latest.md
        echo "" >> target/doc/perf/latest.md

        # Dependencies count
        echo "## Dependencies" >> target/doc/perf/latest.md
        cargo tree --all-features | wc -l | awk '{print "- Total dependencies: " $1}' >> target/doc/perf/latest.md

    - name: ğŸ“ˆ Generate reports
      run: |
        mkdir -p target/doc/reports

        # Version info
        echo "# ZOS Server Documentation" > target/doc/reports/index.md
        echo "" >> target/doc/reports/index.md
        echo "Generated: $(date -Iseconds)" >> target/doc/reports/index.md
        echo "Commit: ${{ github.sha }}" >> target/doc/reports/index.md
        echo "Branch: ${{ github.ref_name }}" >> target/doc/reports/index.md
        echo "" >> target/doc/reports/index.md

        # Code metrics
        echo "## Code Metrics" >> target/doc/reports/index.md
        find src -name "*.rs" | wc -l | awk '{print "- Rust files: " $1}' >> target/doc/reports/index.md
        find src -name "*.rs" -exec wc -l {} + | tail -1 | awk '{print "- Lines of code: " $1}' >> target/doc/reports/index.md

        # Feature flags
        echo "" >> target/doc/reports/index.md
        echo "## Features" >> target/doc/reports/index.md
        grep -A 20 '\[features\]' Cargo.toml | grep '=' | awk -F'=' '{print "- " $1}' >> target/doc/reports/index.md || true

    - name: ğŸ¨ Create documentation site
      run: |
        mkdir -p docs-site
        cp -r target/doc/* docs-site/

        # Create index page
        cat > docs-site/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>ZOS Server Documentation</title>
            <style>
                body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 40px; }
                .nav { background: #f6f8fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
                .nav a { margin-right: 20px; text-decoration: none; color: #0969da; }
                .nav a:hover { text-decoration: underline; }
                .section { margin: 20px 0; }
            </style>
        </head>
        <body>
            <h1>ğŸš€ ZOS Server Documentation</h1>
            <div class="nav">
                <a href="zos_server/index.html">ğŸ“– API Documentation</a>
                <a href="reports/index.html">ğŸ“Š Reports</a>
                <a href="perf/latest.html">âš¡ Performance</a>
            </div>

            <div class="section">
                <h2>Zero Ontology System Server</h2>
                <p>A complete plugin-based computation platform with mathematical proofs, zero-knowledge verification, and universal architecture support.</p>
            </div>

            <div class="section">
                <h3>ğŸ—ï¸ Architecture Layers</h3>
                <ul>
                    <li><strong>Layer -4</strong>: Advanced ZK (Rollups, Lattice Folding, HME, MetaCoq, Lean4)</li>
                    <li><strong>Layer -3</strong>: Zero Knowledge (ZK-SNARKs, ZK-STARKs, Correctness Proofs)</li>
                    <li><strong>Layer -2</strong>: Regulatory (SEC, Quality, GDPR/HIPAA/SOX/ISO)</li>
                    <li><strong>Layer -1</strong>: Governance (Voting, Resources, ERP)</li>
                    <li><strong>Layer 0</strong>: Foundation (LMFDB, Wikidata, OSM, Archive.org, SDF.org)</li>
                    <li><strong>Layer 1</strong>: System (19 plugins: SystemD, Docker, Compilers, Blockchain, etc.)</li>
                    <li><strong>Layer 2</strong>: Data Formats (Parquet, HuggingFace, RDF, SQL, Protocols)</li>
                    <li><strong>Layer âˆ</strong>: Recursive (Each layer exports to all others infinitely)</li>
                </ul>
            </div>
        </body>
        </html>
        EOF

        # Convert markdown reports to HTML
        if command -v pandoc >/dev/null 2>&1; then
            pandoc reports/index.md -o reports/index.html --standalone --css=../style.css || cp reports/index.md reports/index.html
            pandoc perf/latest.md -o perf/latest.html --standalone --css=../style.css || cp perf/latest.md perf/latest.html
        else
            cp reports/index.md reports/index.html
            cp perf/latest.md perf/latest.html
        fi

    - name: ğŸš€ Setup Pages
      uses: actions/configure-pages@v4

    - name: ğŸ“¤ Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './docs-site'

    - name: ğŸŒ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
