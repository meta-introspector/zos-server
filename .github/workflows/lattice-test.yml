name: ğŸ¦€ Rustc Flag Lattice Testing

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      job_type:
        description: 'Job type: "gap-detect", "gap-fill", or "slice"'
        required: true
        default: 'gap-detect'
        type: choice
        options:
        - gap-detect
        - gap-fill
        - slice
      lattice_slice:
        description: 'Lattice slice pattern (e.g., "L0.*", "*.*.0.*")'
        required: false
        default: 'auto'
      batch_size:
        description: 'Number of combinations to test'
        required: false
        default: '10'
      optimization_level:
        description: 'Optimization level filter (0,1,2,3,s,z or "all")'
        required: false
        default: 'all'

jobs:
  lattice-test:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    - name: ğŸ“¥ Checkout code
      run: |
        git clone https://github.com/meta-introspector/zos-server.git .
        git checkout ${{ github.sha }}

    - name: ğŸ¦€ Install Rust
      run: |
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source ~/.cargo/env
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        rustup component add rustfmt clippy

    - name: ğŸ“Š Download previous results
      run: |
        # Try to download previous results artifact
        echo "Checking for previous lattice results..."
        mkdir -p lattice_test_results

        # Create a simple script to check existing results
        echo "Previous results will be preserved if they exist"

    - name: ğŸ§  Intelligent slice planning and execution
      run: |
        source ~/.cargo/env

        JOB_TYPE="${{ github.event.inputs.job_type || 'gap-detect' }}"
        LATTICE_SLICE="${{ github.event.inputs.lattice_slice || 'auto' }}"
        BATCH_SIZE="${{ github.event.inputs.batch_size || '10' }}"

        echo "ğŸ¯ Job Type: $JOB_TYPE"
        echo "ğŸ“Š Lattice Slice: $LATTICE_SLICE"
        echo "ğŸ“¦ Batch Size: $BATCH_SIZE"
        echo "ğŸŒ Runner ID: ${{ github.run_id }}"
        echo "ğŸ”¢ Run Number: ${{ github.run_number }}"

        # Run intelligent slicer
        python3 intelligent_slicer.py "$JOB_TYPE" "$LATTICE_SLICE" "$BATCH_SIZE" > slice_output.txt

        echo "ğŸ§  Intelligent Slice Analysis:"
        cat slice_output.txt

        # Extract and execute work items
        echo ""
        echo "ğŸ”¬ Executing assigned work items:"

        grep -E "^L[0-9]" slice_output.txt | while IFS='|' read -r coord rustflags features profile; do
          echo "Testing $coord: $features ($profile)"

          result_file="lattice_test_results/${coord}_${features}_${profile}.result"
          log_file="lattice_test_results/${coord}_${features}_${profile}.log"

          mkdir -p lattice_test_results

          # Skip if already tested
          if [ -f "$result_file" ]; then
            echo "â­ï¸  $coord: SKIPPED (already tested)"
            continue
          fi

          # Test with timeout
          export RUSTFLAGS="$rustflags"

          if timeout 120 cargo build --features "$features" --profile "$profile" > "$log_file" 2>&1; then
            echo "SUCCESS" > "$result_file"
            echo "âœ… $coord: SUCCESS"
          else
            echo "FAILED" > "$result_file"
            echo "âŒ $coord: FAILED"
          fi

          # Clean for next test
          cargo clean > /dev/null 2>&1 || true
          unset RUSTFLAGS
        done

    - name: ğŸ”¬ Run incremental lattice tests
      run: |
        source ~/.cargo/env

        # Set batch size from input or default
        BATCH_SIZE="${{ github.event.inputs.batch_size || '10' }}"

        # Modify the incremental tester for this batch size
        sed -i "s/BATCH_SIZE=5/BATCH_SIZE=$BATCH_SIZE/" incremental_lattice_test.sh
        sed -i "s/MAX_TOTAL_TESTS=50/MAX_TOTAL_TESTS=$((BATCH_SIZE * 2))/" incremental_lattice_test.sh

        # Run the tests
        ./incremental_lattice_test.sh

    - name: ğŸ“Š Generate lattice report
      run: |
        source ~/.cargo/env

        # Create comprehensive report
        cat > lattice_report.md << 'EOF'
        # Rustc Flag Lattice Test Report

        **Generated:** $(date -Iseconds)
        **Commit:** ${{ github.sha }}
        **Workflow:** ${{ github.run_id }}

        ## Summary
        EOF

        # Add summary stats
        if [ -f "lattice_test_results/summary.md" ]; then
          cat lattice_test_results/summary.md >> lattice_report.md
        fi

        echo "" >> lattice_report.md
        echo "## Test Environment" >> lattice_report.md
        echo "- Runner: ubuntu-latest" >> lattice_report.md
        echo "- Rust version: $(rustc --version)" >> lattice_report.md
        echo "- Cargo version: $(cargo --version)" >> lattice_report.md

        # Add failed combinations for analysis
        echo "" >> lattice_report.md
        echo "## Failed Combinations" >> lattice_report.md
        find lattice_test_results -name "*.result" -exec grep -l "FAILED" {} \; | head -5 | while read file; do
          basename=$(basename "$file" .result)
          echo "- $basename" >> lattice_report.md
        done

    - name: ğŸ“¦ Archive lattice results
      run: |
        # Create archive with timestamp
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        ARCHIVE_NAME="lattice_results_${TIMESTAMP}_${{ github.sha }}"

        mkdir -p "archives/$ARCHIVE_NAME"

        # Copy all results
        cp -r lattice_test_results/* "archives/$ARCHIVE_NAME/" 2>/dev/null || true
        cp rustc_flag_lattice.json "archives/$ARCHIVE_NAME/" 2>/dev/null || true
        cp lattice_report.md "archives/$ARCHIVE_NAME/" 2>/dev/null || true

        # Create index of all archives
        echo "# Lattice Test Archives" > archives/index.md
        echo "" >> archives/index.md
        echo "Generated: $(date -Iseconds)" >> archives/index.md
        echo "" >> archives/index.md

        for dir in archives/lattice_results_*; do
          if [ -d "$dir" ]; then
            dirname=$(basename "$dir")
            echo "- [$dirname](./$dirname/)" >> archives/index.md
          fi
        done

        echo "ğŸ“¦ Created archive: $ARCHIVE_NAME"
        ls -la "archives/$ARCHIVE_NAME/"

    - name: ğŸ’¾ Commit results to repository
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # Add new results
        git add archives/ lattice_test_results/ rustc_flag_lattice.json lattice_report.md 2>/dev/null || true

        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No new results to commit"
        else
          git commit -m "ğŸ§ª Lattice test results $(date -Iseconds)

          - Tested combinations from commit ${{ github.sha }}
          - Results archived with timestamp
          - Incremental testing preserves previous results"

          git push
        fi

    - name: ğŸ“Š Upload artifacts
      run: |
        # Create a simple artifact upload using tar
        if [ -d "lattice_test_results" ]; then
          tar -czf lattice-results.tar.gz lattice_test_results/ archives/ lattice_report.md
          echo "ğŸ“¦ Created lattice-results.tar.gz"
          ls -lh lattice-results.tar.gz
        fi

    - name: ğŸ“ˆ Summary
      run: |
        echo "ğŸ¯ Lattice Testing Complete"
        echo "=========================="

        if [ -f "lattice_test_results/summary.md" ]; then
          echo "ğŸ“Š Results:"
          grep -E "(Successful|Failed|Total)" lattice_test_results/summary.md || echo "Summary not available"
        fi

        echo ""
        echo "ğŸ“ Results committed to repository in archives/"
        echo "ğŸ”„ Run workflow again to test more combinations"
